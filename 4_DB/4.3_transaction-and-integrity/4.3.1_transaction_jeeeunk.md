## 4.3.1 트랜잭션 Transaction

- DB에서 하나의 논리적 기능을 수행하기 위한 작업의 단위
- 여러 개의 쿼리를 하나로 묶는 단위
    - 쿼리: DB에 접근하는 방법
- 특성: ACID (원자성, 일관성, 독립성, 지속성)

### 커밋 Commit & 롤백 Rollback

- 커밋: 여러 쿼리가 성공적으로 처리되었다고 확정하는 명령어로, 트랜잭션 단위로 수행되며, 변경한 내용이 모두 영구적으로 저장
- 롤백: 트랜잭션으로 처리한 하나의 묶음 과정이 처리되기 전으로 되돌리는 것
- 데이터의 무결성을 보장할 수 있음

### 트랜잭션 전파

- 트랜잭션 수행 시 커넥션 단위로 수행하기에 커넥션 전체를 넘겨 수행하는 대신, 여러 트랜잭션 관련 메세드의 호출을 하나의 트랜잭션에 묶이도록 하는 것

```java
// Spring 프레임워크에서 @Transactional 애노테이션을 통해 
// 여러 쿼리 관련 코드를 하나의 트랜잭션으로 처리
@Service
@Transactional(readOnly = true)
public class MemberService {
	private final MemberRepository memberRepository;
	public MemberService (MemberRepository memberRepository) {
		this.memberRepository = memberRepository;
	}
}
```

### 원자성 Atomicity

- All or nothing
- 트랜잭션과 관련된 일이 모두 수행 되었음, 혹은 모두 수행되지 않았음을 보장하는 특징
- 트랜잭션 로직에서 외부 API등을 호출하는 등 롤백이 필요할 때 해결 방법을 준비해야 함

### 일관성 Consistency

- 허용된 방식으로만 데이터를 변경해야 하는 것
- DB에 기록된 모든 데이터는 여러 가지 조건, 규칙을 충족해야 유효하다는 것

### 독립성 Isolation

- 트랜잭션 수행 시 서로 끼어들지 못하는 것
- 복수의 병렬 트랜잭션은 서로 격리되어 마치 순차적으로 실행되는 것 처럼 작동해야 함
- DB는 여러 사용자가 같은 데이터에 접근할 수 있어야 함
- 격리 수준
    - SERIALIZABLE (격리성이 가장 높고, 동시성이 가장 낮음)
        - 트랜잭션을 순차적으로 진행하는 것
        - 여러 트랜잭션이 동시에 같은 행에 접근할 수 없음
        - 상대적으로 교착 상태가 일어날 확률이 높고 성능이 가장 낮음
    - REPEATABLE_READ
        - 하나의 트랜잭션이 수정한 행을 다른 트랜잭션이 수정할 수 없지만, 새로운 행을 추가할 수 있어 팬텀 리드 현상 발생 가능
        - 팬텀 리드 phantom read: 한 트랜잭션 내에서 동일한 쿼리를 보냈을 때 해당 조회 결과 (행)가 다른 경우
    - READ_COMMITED
        - 가장 많이 사용되는 격리 수준
        - 다른 트랜잭션이 커밋 완료한 데이터만 조회 허용
        - 어떤 트랜잭션이 접근한 행을 다른 트랜잭션이 수정 가능해 동일한 행을 다시 읽으면 다른 내용 발견 가능, 팬텀 리드 현상과 반복 가능하지 않은 조회 현상 발생 가능
        - 반복 가능하지 않은 조회 non-repeatable read: 한 트랜잭션 내 같은 행에 두 번 이상 조회가 발생했는데, 해당 행의 값이 다른 경우
    - READ_UNCOMMITTED(격리성이 가장 낮고, 동시성이 가장 높음)
        - 다른 트랜잭션이 커밋 완료하지 않은 데이터에도 접근 가능, 팬텀 리드, 반복 가능하지 않은 조회, 더티 리드 현상 발생 가능
        - 데이터 무결성이 보장되지 않음
        - 더티 리드 dirty read: 한 트랜잭션이 실행 중일 때 다른 트랜잭션에 의해 수정되었지만 아직 커밋되지 않은 행의 데이터를 읽을 수 있을 때 발생

### 지속성 Durability

- 성공적으로 수행된 트랜잭션은 영원히 반영되어야 하는 것
- DB에 시스템 장애가 발생해도 원래 상태로 복구하는 회복 기능이 있어야 함을 의미
- DB는 지속성을 위해  체크섬, 저널링, 롤백 기능을 제공
    - 체크섬: 중복 검사의 한 형태로, 오류 정정을 통해 송신된 자료의 무결성을 보호하는 방법
    - 저널링: 파일 시스템 또는 DB 시스템에 변경 사항을 반영 commit하기 전에 로깅하는 것, 트랜잭션 등 변경 사항에 대한 로그를 남기는 것